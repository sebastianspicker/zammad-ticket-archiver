{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "zammad-pdf-archiver config",
  "type": "object",
  "additionalProperties": false,
  "description": "Schema matching src/config/settings.py (runtime validation is done by Pydantic).",
  "properties": {
    "server": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "host": { "type": "string" },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "webhook_shared_secret": { "type": ["string", "null"] }
      }
    },
    "zammad": {
      "type": "object",
      "additionalProperties": false,
      "required": ["base_url", "api_token"],
      "properties": {
        "base_url": { "type": "string", "format": "uri" },
        "api_token": { "type": "string" },
        "webhook_hmac_secret": { "type": ["string", "null"] },
        "timeout_seconds": { "type": "number", "exclusiveMinimum": 0 },
        "verify_tls": { "type": "boolean" }
      }
    },
    "workflow": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "trigger_tag": { "type": "string" },
        "require_tag": { "type": "boolean" },
        "acknowledge_on_success": { "type": "boolean" },
        "delivery_id_ttl_seconds": { "type": "integer", "minimum": 0 },
        "execution_backend": { "type": "string", "enum": ["inprocess", "redis_queue"] },
        "idempotency_backend": { "type": "string", "enum": ["memory", "redis"] },
        "redis_url": { "type": ["string", "null"] },
        "queue_stream": { "type": "string" },
        "queue_group": { "type": "string" },
        "queue_consumer": { "type": ["string", "null"] },
        "queue_read_block_ms": { "type": "integer", "minimum": 100, "maximum": 60000 },
        "queue_read_count": { "type": "integer", "minimum": 1, "maximum": 1000 },
        "queue_retry_max_attempts": { "type": "integer", "minimum": 0, "maximum": 50 },
        "queue_retry_backoff_seconds": { "type": "number", "exclusiveMinimum": 0 },
        "queue_dlq_stream": { "type": "string" },
        "history_stream": { "type": "string" },
        "history_retention_maxlen": { "type": "integer", "minimum": 0, "maximum": 1000000 }
      }
    },
    "fields": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "archive_path": { "type": "string" },
        "archive_user_mode": { "type": "string" },
        "archive_user": { "type": "string" }
      }
    },
    "storage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["root"],
      "properties": {
        "root": { "type": "string" },
        "atomic_write": { "type": "boolean" },
        "fsync": { "type": "boolean" },
        "path_policy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow_prefixes": { "type": "array", "items": { "type": "string" } },
            "sanitize": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "replace_whitespace": { "type": "string" },
                "strip_control_chars": { "type": "boolean" }
              }
            },
            "filename_pattern": { "type": "string" }
          }
        }
      }
    },
    "pdf": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "template_variant": { "type": "string" },
        "templates_root": { "type": ["string", "null"] },
        "locale": { "type": "string" },
        "timezone": { "type": "string" },
        "max_articles": { "type": "integer", "minimum": 0 },
        "article_limit_mode": { "type": "string", "enum": ["fail", "cap_and_continue"] },
        "include_attachment_binary": { "type": "boolean" },
        "max_attachment_bytes_per_file": { "type": "integer", "minimum": 0 },
        "max_total_attachment_bytes": { "type": "integer", "minimum": 0 }
      }
    },
    "signing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "pfx_path": { "type": ["string", "null"] },
        "pfx_password": { "type": ["string", "null"] },
        "pades": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cert_path": { "type": ["string", "null"] },
            "key_path": { "type": ["string", "null"] },
            "key_password": { "type": ["string", "null"] },
            "reason": { "type": "string" },
            "location": { "type": "string" }
          }
        },
        "timestamp": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean" },
            "rfc3161": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "tsa_url": { "type": ["string", "null"], "format": "uri" },
                "timeout_seconds": { "type": "number", "exclusiveMinimum": 0 },
                "ca_bundle_path": { "type": ["string", "null"] },
                "user": { "type": ["string", "null"] },
                "password": { "type": ["string", "null"] }
              }
            }
          }
        }
      }
    },
    "observability": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "log_level": { "type": "string" },
        "log_format": { "type": ["string", "null"] },
        "json_logs": { "type": "boolean" },
        "metrics_enabled": { "type": "boolean" },
        "metrics_bearer_token": { "type": ["string", "null"] },
        "healthz_omit_version": { "type": "boolean" }
      }
    },
    "hardening": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "rate_limit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean" },
            "rps": { "type": "number", "minimum": 0 },
            "burst": { "type": "integer", "minimum": 1 },
            "include_metrics": { "type": "boolean" },
            "client_key_header": { "type": ["string", "null"] }
          }
        },
        "body_size_limit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "max_bytes": { "type": "integer", "minimum": 0 }
          }
        },
        "webhook": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow_unsigned": { "type": "boolean" },
            "allow_unsigned_when_no_secret": { "type": "boolean" },
            "require_delivery_id": { "type": "boolean" }
          }
        },
        "transport": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "trust_env": { "type": "boolean" },
            "allow_insecure_http": { "type": "boolean" },
            "allow_insecure_tls": { "type": "boolean" },
            "allow_local_upstreams": { "type": "boolean" }
          }
        }
      }
    },
    "admin": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "bearer_token": { "type": ["string", "null"] },
        "history_limit": { "type": "integer", "minimum": 1, "maximum": 5000 }
      }
    }
  },
  "required": ["zammad", "storage"]
}
