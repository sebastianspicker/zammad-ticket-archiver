{% extends "shared/article-list-ticket.html" %}

{% macro party(value) -%}
{%- if not value -%}
—
{%- else -%}
{%- if value.name -%}{{ value.name }}{%- elif value.login -%}{{ value.login }}{%- elif value.email -%}{{ value.email }}{%- else -%}—{%- endif -%}
{%- if value.email and value.name -%} <span class="muted">&lt;{{ value.email }}&gt;</span>{%- endif -%}
{%- if value.login and value.name -%} <span class="muted">({{ value.login }})</span>{%- endif -%}
{%- endif -%}
{%- endmacro %}

{% block ticket_meta %}
{% set custom_fields = ticket.custom_fields if ticket.custom_fields is defined else {} %}
{% set archive_path = custom_fields.get("archive_path") %}
{% set archive_user_mode = custom_fields.get("archive_user_mode") %}

<section class="ticket-meta" aria-label="Ticket metadata">
  <dl class="meta-grid">
    <div class="meta-item">
      <dt>Created</dt>
      <dd>{{ fmt_dt(ticket.created_at) }}</dd>
    </div>
    <div class="meta-item">
      <dt>Updated</dt>
      <dd>{{ fmt_dt(ticket.updated_at) }}</dd>
    </div>
    <div class="meta-item">
      <dt>Requester / Customer</dt>
      <dd>{{ party(ticket.customer) }}</dd>
    </div>
    <div class="meta-item">
      <dt>Owner</dt>
      <dd>{{ party(ticket.owner) }}</dd>
    </div>
    <div class="meta-item meta-item--wide">
      <dt>Tags</dt>
      <dd>{% if ticket.tags %}{{ ticket.tags | join(", ") }}{% else %}—{% endif %}</dd>
    </div>
    <div class="meta-item meta-item--wide">
      <dt>Archive path</dt>
      <dd>
        {% if archive_path is sequence and archive_path is not string %}
        {{ archive_path | join(" > ") }}
        {% elif archive_path %}
        {{ archive_path }}
        {% else %}
        —
        {% endif %}
      </dd>
    </div>
    <div class="meta-item">
      <dt>Archive user mode</dt>
      <dd>{{ archive_user_mode if archive_user_mode else "—" }}</dd>
    </div>
  </dl>
</section>
{% endblock %}

{% block after_articles %}
<section class="section">
  <h2 class="section-title">Attachments (index)</h2>
  {% set articles_with_attachments = articles | selectattr("attachments") | list %}
  {% if articles_with_attachments %}
  <ul class="attachment-index">
    {% for article in articles_with_attachments %}
    {% for att in article.attachments %}
    <li class="attachment-index-item">
      <span class="attachment-name">{{ att.filename if att.filename else "Unnamed file" }}</span>
      <span class="attachment-meta">
        article #{{ article.id }}
        {% if article.created_at %} · {{ fmt_dt(article.created_at) }}{% endif %}
        {% if att.content_type %} · {{ att.content_type }}{% endif %}
        {% if att.size %} · {{ att.size }} B{% endif %}
      </span>
    </li>
    {% endfor %}
    {% endfor %}
  </ul>
  {% else %}
  <p class="muted">No attachments.</p>
  {% endif %}
</section>

<footer class="footer">
  <small class="muted">Generated by zammad-pdf-archiver</small>
</footer>
{% endblock %}
