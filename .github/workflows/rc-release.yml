name: RC Release

on:
  push:
    tags:
      - "v*-rc.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Build artifacts
        run: |
          python -m pip install -U pip build
          python -m build

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.whl *.tar.gz > SHA256SUMS

      - name: Extract release notes from changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          awk -v header="## ["$VERSION"]" '
            BEGIN {in_section=0}
            $0 == header {in_section=1; next}
            /^## \[/ && in_section==1 {exit}
            in_section==1 {print}
          ' CHANGELOG.md > release-notes.md
          if [ ! -s release-notes.md ]; then
            {
              echo "Release candidate ${GITHUB_REF_NAME}"
              echo
              echo "No dedicated changelog section found for ${VERSION}."
            } > release-notes.md
          fi

      - name: Create GitHub prerelease
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          prerelease: true
          body_path: release-notes.md
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS
